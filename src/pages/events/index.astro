---
import Layout from "../../layouts/Layout.astro";
import EventCard from "../../components/events/EventCard.astro";
import { getEvents } from "../../services/firebase/events";
import Sidebar from "../../components/Sidebar.astro";
import MobileHeader from "../../components/MobileHeader.astro";

const events = await getEvents("published");
---

<Layout title="Eventos - Biblioteca Digital">
  <div
    class="flex flex-col lg:flex-row min-h-screen bg-[var(--m3-sys-light-surface)]"
  >
    <MobileHeader />
    <Sidebar />
    <main
      class="flex-1 p-4 lg:p-8 h-auto lg:h-screen overflow-y-auto overflow-x-hidden"
    >
      <div class="max-w-7xl mx-auto space-y-8">
        <!-- Development Warning Banner -->
        <div
          class="bg-[var(--m3-sys-tertiary-container)] text-[var(--m3-sys-on-tertiary-container)] p-4 rounded-xl flex items-start gap-3 border border-[var(--m3-sys-tertiary)]/30"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6 flex-shrink-0"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path
              d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
            ></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <div>
            <h3 class="font-bold text-sm uppercase tracking-wide">
              Función en Desarrollo
            </h3>
            <p class="text-sm opacity-90 mt-1">
              La sección de eventos está actualmente en fase beta. Es posible
              que encuentres algunos errores o funcionalidades incompletas
              mientras trabajamos en mejorarla.
            </p>
          </div>
        </div>

        <div
          class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
        >
          <div>
            <h1 class="text-3xl font-bold text-[var(--m3-sys-on-surface)]">
              Próximos Eventos
            </h1>
            <p class="text-[var(--m3-sys-on-surface-variant)] mt-2">
              Descubre y participa en las actividades de la biblioteca.
            </p>
          </div>

          <!-- Admin Action (Visual only, protected by page rules/auth state) -->
          <div id="admin-actions" class="hidden">
            <a
              href="/events/create"
              class="inline-flex items-center px-4 py-2 bg-[var(--m3-sys-primary)] text-[var(--m3-sys-on-primary)] rounded-lg hover:opacity-90 transition-colors shadow-sm"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"></path></svg
              >
              Crear Evento
            </a>
          </div>
        </div>

        {
          events.length === 0 ? (
            <div class="text-center py-12 bg-[var(--m3-sys-surface)] rounded-xl shadow-sm border border-[var(--m3-sys-outline)]/20">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-16 w-16 mx-auto text-[var(--m3-sys-outline)] opacity-50 mb-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <h3 class="text-lg font-medium text-[var(--m3-sys-on-surface)]">
                No hay eventos próximos
              </h3>
              <p class="text-[var(--m3-sys-on-surface-variant)]">
                Vuelve más tarde para ver nuevas actividades.
              </p>
            </div>
          ) : (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {events.map((event) => (
                <EventCard event={event} />
              ))}
            </div>
          )
        }
      </div>
    </main>
  </div>
</Layout>

<script>
  import { auth } from "../../lib/firebase";
  import { onAuthStateChanged } from "firebase/auth";
  import { doc, getDoc, getFirestore } from "firebase/firestore";

  const db = getFirestore();
  const adminActions = document.getElementById("admin-actions");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists() && userDoc.data().role === "admin") {
        if (adminActions) adminActions.classList.remove("hidden");
      }
    }
  });
</script>
