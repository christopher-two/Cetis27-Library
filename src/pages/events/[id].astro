---
import Layout from "../../layouts/Layout.astro";
import EventRegistrationModal from "../../features/events/EventRegistrationModal.astro";
import { getEventById } from "../../services/firebase/events";
import Sidebar from "../../components/Sidebar.astro";
import MobileHeader from "../../components/MobileHeader.astro";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/events");
}

const event = await getEventById(id);

if (!event) {
  return Astro.redirect("/404");
}

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat("es-MX", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric",
  }).format(date);
};

const formatTime = (date: Date) => {
  return new Intl.DateTimeFormat("es-MX", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: true,
  }).format(date);
};

const bgImage =
  event.bannerUrl ||
  "https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=2940&auto=format&fit=crop";
---

<Layout title={`${event.title} - Eventos`}>
  <div
    class="flex flex-col lg:flex-row min-h-screen bg-[var(--m3-sys-background)]"
  >
    <MobileHeader />
    <Sidebar />

    <main
      class="flex-1 h-auto lg:h-screen overflow-y-auto overflow-x-hidden relative"
    >
      <!-- Hero Section with Parallax-like effect -->
      <div class="relative w-full h-[50vh] lg:h-[60vh] overflow-hidden">
        <div class="absolute inset-0 bg-black/40 z-10"></div>
        <div
          class="absolute inset-0 bg-gradient-to-t from-[var(--m3-sys-background)] to-transparent z-20"
        >
        </div>
        <img
          src={bgImage}
          alt={event.title}
          class="w-full h-full object-cover object-center transform scale-105"
        />

        <!-- Hero Content -->
        <div class="absolute bottom-0 left-0 w-full p-6 lg:p-12 z-30">
          <div class="max-w-5xl mx-auto w-full">
            <div class="flex flex-wrap gap-3 mb-4">
              <span
                class={`px-4 py-1.5 rounded-full text-sm font-bold tracking-wide uppercase backdrop-blur-md border border-white/20 ${
                  event.status === "published"
                    ? "bg-emerald-500/20 text-emerald-100 border-emerald-500/30"
                    : "bg-white/10 text-white"
                }`}
              >
                {event.status === "published" ? "Confirmado" : event.status}
              </span>
              <span
                class="px-4 py-1.5 rounded-full text-sm font-medium bg-white/10 text-white backdrop-blur-md border border-white/20"
              >
                {event.registeredCount} / {event.capacity} Lugares Ocupados
              </span>
            </div>

            <h1
              class="text-4xl md:text-5xl lg:text-7xl font-black text-white mb-6 leading-tight max-w-4xl drop-shadow-xl"
            >
              {event.title}
            </h1>

            <div
              class="flex flex-wrap items-center gap-6 text-white/90 font-medium text-sm md:text-base"
            >
              <div
                class="flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-lg border border-white/10"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-[var(--m3-sys-primary)]"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><rect x="3" y="4" width="18" height="18" rx="2" ry="2"
                  ></rect><line x1="16" y1="2" x2="16" y2="6"></line><line
                    x1="8"
                    y1="2"
                    x2="8"
                    y2="6"></line><line x1="3" y1="10" x2="21" y2="10"
                  ></line></svg
                >
                <span class="capitalize">{formatDate(event.startDate)}</span>
              </div>
              <div
                class="flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-lg border border-white/10"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-[var(--m3-sys-primary)]"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><circle cx="12" cy="12" r="10"></circle><polyline
                    points="12 6 12 12 16 14"></polyline></svg
                >
                <span>{formatTime(event.startDate)} hrs</span>
              </div>
              <div
                class="flex items-center gap-2 bg-black/30 backdrop-blur-sm px-4 py-2 rounded-lg border border-white/10"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 text-[var(--m3-sys-primary)]"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path><circle cx="12" cy="10" r="3"></circle></svg
                >
                <span>{event.location}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Grid -->
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 -mt-8 relative z-40"
      >
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
          <!-- Left Column details -->
          <div class="lg:col-span-2 space-y-12">
            {/* About Section */}
            <section class="prose prose-lg prose-invert max-w-none">
              <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-1 bg-[var(--m3-sys-primary)] rounded-full">
                </div>
                <h2
                  class="text-2xl font-bold text-[var(--m3-sys-on-surface)] m-0"
                >
                  Sobre el Evento
                </h2>
              </div>
              <p
                class="text-[var(--m3-sys-on-surface-variant)] leading-relaxed text-lg whitespace-pre-line"
              >
                {event.description}
              </p>
            </section>

            <div class="grid md:grid-cols-2 gap-8">
              {/* Requirements */}
              {
                event.requirements && event.requirements.length > 0 && (
                  <section class="bg-[var(--m3-sys-surface-container-low)] p-6 rounded-2xl border border-[var(--m3-sys-outline)]/10">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="p-2 rounded-lg bg-[var(--m3-sys-primary-container)] text-[var(--m3-sys-on-primary-container)]">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-5 h-5"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <>
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                          </>
                        </svg>
                      </div>
                      <h3 class="text-xl font-semibold text-[var(--m3-sys-on-surface)]">
                        Requisitos
                      </h3>
                    </div>
                    <ul class="space-y-3">
                      {event.requirements.map((req) => (
                        <li class="flex items-start gap-3 text-[var(--m3-sys-on-surface-variant)]">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-[var(--m3-sys-primary)] flex-shrink-0 mt-0.5"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="20 6 9 17 4 12" />
                          </svg>
                          <span>{req}</span>
                        </li>
                      ))}
                    </ul>
                  </section>
                )
              }

              {/* Rules */}
              {
                event.rules && event.rules.length > 0 && (
                  <section class="bg-[var(--m3-sys-surface-container-low)] p-6 rounded-2xl border border-[var(--m3-sys-outline)]/10">
                    <div class="flex items-center gap-3 mb-4">
                      <div class="p-2 rounded-lg bg-[var(--m3-sys-error-container)] text-[var(--m3-sys-on-error-container)]">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-5 h-5"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <>
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="8" x2="12" y2="12" />
                            <line x1="12" y1="16" x2="12.01" y2="16" />
                          </>
                        </svg>
                      </div>
                      <h3 class="text-xl font-semibold text-[var(--m3-sys-on-surface)]">
                        Reglas
                      </h3>
                    </div>
                    <ul class="space-y-3">
                      {event.rules.map((rule) => (
                        <li class="flex items-start gap-3 text-[var(--m3-sys-on-surface-variant)]">
                          <span class="w-1.5 h-1.5 rounded-full bg-[var(--m3-sys-error)] mt-2.5 flex-shrink-0" />
                          <span>{rule}</span>
                        </li>
                      ))}
                    </ul>
                  </section>
                )
              }
            </div>

            {/* Admin Panel (Conditionally Visible) */}
            <div
              id="admin-panel"
              class="hidden mt-12 pt-8 border-t border-[var(--m3-sys-outline)]/20"
            >
              <div
                class="bg-[var(--m3-sys-surface-container)] rounded-2xl border border-[var(--m3-sys-outline)]/20 overflow-hidden"
              >
                <div
                  class="p-6 border-b border-[var(--m3-sys-outline)]/20 flex flex-wrap justify-between items-center gap-4 bg-[var(--m3-sys-surface-container-high)]"
                >
                  <div>
                    <h3
                      class="text-lg font-bold text-[var(--m3-sys-on-surface)] flex items-center gap-2"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5 text-[var(--m3-sys-primary)]"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path
                          d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"
                        ></path><path
                          d="M8.5 8.5a2.12 2.12 0 1 1 3 3 2.12 2.12 0 0 1-3-3Z"
                        ></path><path d="M7 13.01a3 3 0 0 0-6 0"></path><path
                          d="M17 14.99a3 3 0 0 0-6 0"></path></svg
                      >
                      Consola de Administración
                    </h3>
                    <p
                      class="text-xs text-[var(--m3-sys-on-surface-variant)] opacity-70 mt-1"
                    >
                      Solo visible para administradores
                    </p>
                  </div>
                  <button
                    id="admin-edit-btn"
                    class="px-4 py-2 bg-[var(--m3-sys-secondary-container)] text-[var(--m3-sys-on-secondary-container)] rounded-lg text-sm font-semibold hover:opacity-80 transition-all flex items-center gap-2"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      ><path
                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                      ></path><path
                        d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                      ></path></svg
                    >
                    Editar Evento
                  </button>
                </div>

                <div class="p-6 grid md:grid-cols-2 gap-8">
                  <div class="space-y-4">
                    <h4
                      class="text-sm font-bold uppercase tracking-wider text-[var(--m3-sys-on-surface-variant)]"
                    >
                      Lista de Asistentes
                    </h4>
                    <div
                      id="admin-participants-list"
                      class="max-h-60 overflow-y-auto pr-2 space-y-2"
                    >
                      <!-- Injected by JS -->
                    </div>
                  </div>

                  <div class="space-y-4">
                    <h4
                      class="text-sm font-bold uppercase tracking-wider text-[var(--m3-sys-on-surface-variant)]"
                    >
                      Registro Manual
                    </h4>
                    <form id="admin-manual-reg-form" class="space-y-3">
                      <input
                        type="text"
                        name="userName"
                        placeholder="Nombre Completo"
                        required
                        class="w-full px-4 py-2.5 rounded-lg bg-[var(--m3-sys-surface)] border border-[var(--m3-sys-outline)]/30 text-[var(--m3-sys-on-surface)] text-sm focus:border-[var(--m3-sys-primary)] outline-none transition-colors"
                      />
                      <input
                        type="email"
                        name="userEmail"
                        placeholder="Correo Electrónico"
                        class="w-full px-4 py-2.5 rounded-lg bg-[var(--m3-sys-surface)] border border-[var(--m3-sys-outline)]/30 text-[var(--m3-sys-on-surface)] text-sm focus:border-[var(--m3-sys-primary)] outline-none transition-colors"
                      />
                      <button
                        type="submit"
                        class="w-full py-2.5 bg-[var(--m3-sys-primary)] text-[var(--m3-sys-on-primary)] rounded-lg text-sm font-bold focus:ring-2 ring-offset-2 ring-[var(--m3-sys-primary)]"
                      >
                        Registrar Usuario
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column (Sticky Side) -->
          <div class="lg:col-span-1">
            <div class="sticky top-8 space-y-6">
              <!-- Registration Card -->
              <div
                id="public-registration-card"
                class="bg-[var(--m3-sys-surface)] p-6 rounded-3xl shadow-xl border border-[var(--m3-sys-outline)]/10 backdrop-blur-xl"
              >
                <h3
                  class="text-xl font-bold text-[var(--m3-sys-on-surface)] mb-4"
                >
                  Registro
                </h3>

                <div class="space-y-4 mb-6">
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-[var(--m3-sys-on-surface-variant)]"
                      >Cupo Total</span
                    >
                    <span class="font-bold text-[var(--m3-sys-on-surface)]"
                      >{event.capacity} personas</span
                    >
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-[var(--m3-sys-on-surface-variant)]"
                      >Lugares Disponibles</span
                    >
                    <span class="font-bold text-[var(--m3-sys-primary)]"
                      >{
                        Math.max(0, event.capacity - event.registeredCount)
                      }</span
                    >
                  </div>
                  <!-- Progress Bar -->
                  <div
                    class="h-2 w-full bg-[var(--m3-sys-surface-variant)] rounded-full overflow-hidden"
                  >
                    <div
                      class="h-full bg-[var(--m3-sys-primary)] transition-all duration-500 ease-out"
                      style={`width: ${(event.registeredCount / event.capacity) * 100}%`}
                    >
                    </div>
                  </div>
                </div>

                <button
                  id="register-btn"
                  class="w-full py-4 text-center bg-[var(--m3-sys-primary)] text-[var(--m3-sys-on-primary)] rounded-xl font-bold text-lg shadow-lg hover:shadow-primary/50 transition-all transform hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                >
                  Cargando...
                </button>
                <p
                  class="text-xs text-center text-[var(--m3-sys-on-surface-variant)] mt-3 opacity-80"
                >
                  Al registrarte aceptas las reglas del evento.
                </p>
              </div>

              <!-- Map / Location Card Placeholder -->
              <div
                class="bg-[var(--m3-sys-surface-container-low)] p-6 rounded-3xl border border-[var(--m3-sys-outline)]/10"
              >
                <h3
                  class="text-lg font-bold text-[var(--m3-sys-on-surface)] mb-4 flex items-center gap-2"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-5 h-5 text-[var(--m3-sys-secondary)]"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><polygon points="3 11 22 2 13 21 11 13 3 11"
                    ></polygon></svg
                  >
                  Ubicación
                </h3>
                <p class="text-[var(--m3-sys-on-surface-variant)] mb-4">
                  {event.location}
                </p>

                <!-- Interactive Map Placeholder -->
                <div
                  class="w-full h-40 bg-[var(--m3-sys-surface-variant)] rounded-xl flex items-center justify-center text-[var(--m3-sys-on-surface-variant)] overflow-hidden relative group cursor-pointer"
                >
                  <div
                    class="absolute inset-0 bg-cover bg-center opacity-50 group-hover:scale-110 transition-transform duration-700"
                    style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Google_Maps_Logo_2020.svg/2275px-Google_Maps_Logo_2020.svg.png');"
                  >
                  </div>
                  <span
                    class="relative z-10 font-medium bg-white/80 px-3 py-1 rounded-lg backdrop-blur shadow-sm"
                    >Ver en Mapa</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <EventRegistrationModal event={event} />

    <!-- Hidden element to pass data -->
    <div id="event-data" data-event={JSON.stringify(event)} class="hidden">
    </div>
  </div>

  <script>
    import { auth } from "../../lib/firebase";
    import { onAuthStateChanged } from "firebase/auth";
    import {
      getUserRegistrations,
      getEventRegistrations,
      registerForEvent,
    } from "../../services/firebase/events";
    import { getUserProfile } from "../../services/firebase/users";

    const eventDataEl = document.getElementById("event-data");
    const event = eventDataEl
      ? JSON.parse(eventDataEl.dataset.event || "{}")
      : {};

    const registerBtn = document.getElementById(
      "register-btn",
    ) as HTMLButtonElement | null;
    const publicActionCard = document.getElementById(
      "public-registration-card",
    );
    const modal = document.getElementById(
      "registration-modal",
    ) as HTMLDialogElement;
    const adminPanel = document.getElementById("admin-panel");
    const adminParticipantsList = document.getElementById(
      "admin-participants-list",
    );
    const manualRegForm = document.getElementById(
      "admin-manual-reg-form",
    ) as HTMLFormElement;
    const adminEditBtn = document.getElementById("admin-edit-btn");

    if (adminEditBtn) {
      adminEditBtn.onclick = () => {
        window.location.href = `/events/edit/${event.id}`;
      };
    }

    async function loadParticipants() {
      if (!adminParticipantsList) return;

      try {
        const registrations = await getEventRegistrations(event.id);
        if (registrations.length === 0) {
          adminParticipantsList.innerHTML = `
          <div class="text-xs text-[var(--m3-sys-on-surface-variant)] p-4 text-center italic opacity-70">
            No hay participantes registrados aún.
          </div>
        `;
          return;
        }

        adminParticipantsList.innerHTML = registrations
          .map(
            (reg, idx) => `
        <div class="p-3 bg-[var(--m3-sys-surface)] rounded-lg flex items-center gap-3 border border-[var(--m3-sys-outline)]/10 hover:border-[var(--m3-sys-primary)]/30 transition-colors">
          <div class="w-6 h-6 rounded-full bg-[var(--m3-sys-primary-container)] text-[var(--m3-sys-on-primary-container)] flex items-center justify-center text-xs font-bold">
            ${idx + 1}
          </div>
          <div class="min-w-0 flex-1">
            <div class="font-bold text-xs text-[var(--m3-sys-on-surface)] truncate">${reg.userName}</div>
            <div class="text-[10px] text-[var(--m3-sys-on-surface-variant)] font-mono truncate">${reg.userEmail || "Sin correo"}</div>
          </div>
        </div>
      `,
          )
          .join("");
      } catch (e) {
        console.error(e);
        adminParticipantsList.innerHTML =
          '<div class="text-[var(--m3-sys-error)] text-xs p-2">Error al cargar registros.</div>';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      // Reset Default State
      if (registerBtn) {
        registerBtn.className =
          "w-full py-4 text-center bg-[var(--m3-sys-primary)] text-[var(--m3-sys-on-primary)] rounded-xl font-bold text-lg shadow-lg hover:shadow-primary/50 transition-all transform hover:-translate-y-0.5 active:translate-y-0";
        registerBtn.disabled = false;
      }

      if (!user) {
        if (registerBtn) {
          registerBtn.innerHTML = `
            <span>Iniciar Sesión para Inscribirse</span>
          `;
          registerBtn.onclick = () => (window.location.href = "/login");
        }
        adminPanel?.classList.add("hidden");
      } else {
        // Role Check
        try {
          const profile = await getUserProfile(user.uid);
          if (profile?.role === "admin") {
            adminPanel?.classList.remove("hidden");
            loadParticipants();
            // Admins can see the public card too, but maybe with a note?
            // The previous code hid it, but for design consistency it looks better to keep it
            // or we can hide it as before. Let's hide it to avoid confusion or keep it to test.
            // Keeping it visible for now as admins might want to see what users see,
            // but the requirement said "hidden" in the old code. Let's respect old logic relative to the "user view".
            // Actually, let's keep it VISIBLE but disabled or just enabled for them to test flow?
            // Reverting to previous logic: Hide public card if admin to reduce clutter.
            if (publicActionCard) publicActionCard.classList.add("hidden");
          } else {
            adminPanel?.classList.add("hidden");
            if (publicActionCard) publicActionCard.classList.remove("hidden");
          }
        } catch (e) {
          console.error("Error checking role:", e);
        }

        // Check if already registered (for public portion)
        try {
          const regs = await getUserRegistrations(user.uid);
          const isRegistered = regs.some((r) => r.eventId === event.id);

          if (isRegistered && registerBtn) {
            registerBtn.textContent = "¡Ya estás inscrito!";
            registerBtn.disabled = true;
            registerBtn.className =
              "w-full py-4 bg-emerald-600 text-white font-bold rounded-xl shadow-none opacity-90 cursor-default flex items-center justify-center gap-2";
            registerBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <span>¡Ya estás inscrito!</span>
             `;
          } else if (event.registeredCount >= event.capacity && registerBtn) {
            registerBtn.textContent = "Cupo Lleno";
            registerBtn.disabled = true;
            registerBtn.className =
              "w-full py-4 bg-[var(--m3-sys-surface-variant)] text-[var(--m3-sys-on-surface-variant)] font-bold rounded-xl opacity-50 cursor-not-allowed";
          } else if (registerBtn) {
            registerBtn.textContent = "Inscribirse Ahora";
            registerBtn.onclick = () => modal?.showModal();
          }
        } catch (e) {
          console.error(e);
        }
      }
    });

    // Manual Registration Handler
    manualRegForm?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(manualRegForm);
      const userName = formData.get("userName") as string;
      const userEmail = formData.get("userEmail") as string;

      try {
        const manualUser = {
          uid: `manual_${Date.now()}`,
          email: userEmail || `manual_${Date.now()}@example.com`,
          displayName: userName,
        };

        await registerForEvent(event.id, manualUser, {});
        alert("Usuario registrado exitosamente");
        manualRegForm.reset();
        loadParticipants();
      } catch (err: any) {
        alert("Error: " + err.message);
      }
    });
  </script>
</Layout>
