---
import Layout from "../layouts/Layout.astro";
import Card from "../components/ui/Card.astro";
import Button from "../components/ui/Button.astro";
import Sidebar from "../components/Sidebar.astro";
import MobileHeader from "../components/MobileHeader.astro";
import DataTable from "../components/ui/DataTable.astro";
import AddBookSideSheet from "../features/books/AddBookSideSheet.astro";
import EditBookSideSheet from "../features/books/EditBookSideSheet.astro";
import ConfirmDeleteDialog from "../components/ui/ConfirmDeleteDialog.astro";
import Skeleton from "../components/ui/Skeleton.astro";

const headers = [
  "Título",
  "Autor",
  "ISBN",
  "Ubicación",
  "Disponibles",
  "Total",
  "Acciones",
];
---

<Layout
  title="Catálogo de Libros | Biblioteca Digital"
  description="Explora y gestiona el catálogo de libros disponibles en la biblioteca."
>
  <div
    class="flex flex-col lg:flex-row min-h-screen bg-[var(--m3-sys-light-surface)]"
  >
    <!-- Mobile Header -->
    <MobileHeader />

    <!-- Sidebar -->
    <Sidebar />

    <!-- Main Content -->
    <main class="flex-1 p-4 lg:p-8 h-auto lg:h-screen overflow-y-auto">
      <div class="flex flex-col gap-6 mb-8">
        <div
          class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
        >
          <div class="flex flex-col gap-1">
            <h1
              class="text-2xl lg:text-3xl font-normal text-[var(--m3-sys-on-surface)]"
            >
              Catalogo de Libros
            </h1>
          </div>
          <Button
            class="shadow-md w-full sm:w-auto"
            onclick="window.openAddBookSidesheet()"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><path d="M5 12h14"></path><path d="M12 5v14"></path></svg
            >
            Nuevo Libro
          </Button>
        </div>

        <!-- Search Bar -->
        <div class="w-full max-w-sm">
          <div class="relative">
            <input
              type="text"
              id="book-search"
              placeholder="Buscar por título, autor o ISBN..."
              class="w-full pl-10 pr-4 py-2.5 rounded-[var(--m3-radius-xl)] bg-[var(--m3-sys-surface-variant)]/30 text-[var(--m3-sys-on-surface)] border-none outline-none focus:ring-2 focus:ring-[var(--m3-sys-primary)]/50 placeholder:text-[var(--m3-sys-on-surface-variant)]/50 transition-all"
            />
            <div
              class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--m3-sys-on-surface-variant)]"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><circle cx="11" cy="11" r="8"></circle><line
                  x1="21"
                  y1="21"
                  x2="16.65"
                  y2="16.65"></line></svg
              >
            </div>
          </div>
        </div>
      </div>

      <Card variant="outlined" class="!p-0 border-none">
        <DataTable headers={headers} id="books-table">
          <tbody id="books-table-body">
            <!-- Dynamic Content (Skeletons) -->
            {
              [...Array(5)].map(() => (
                <tr>
                  <td class="px-6 py-4">
                    <Skeleton width="140px" height="20px" />
                  </td>
                  <td class="px-6 py-4">
                    <Skeleton width="100px" height="16px" />
                  </td>
                  <td class="px-6 py-4">
                    <Skeleton width="80px" height="16px" />
                  </td>
                  <td class="px-6 py-4">
                    <Skeleton width="90px" height="16px" />
                  </td>
                  <td class="px-6 py-4">
                    <Skeleton width="60px" height="24px" rounded="full" />
                  </td>
                  <td class="px-6 py-4">
                    <Skeleton width="40px" height="16px" />
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex gap-2">
                      <>
                        <Skeleton width="32px" height="32px" rounded="full" />
                        <Skeleton width="32px" height="32px" rounded="full" />
                      </>
                    </div>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </DataTable>
      </Card>

      <AddBookSideSheet />
      <EditBookSideSheet />
      <ConfirmDeleteDialog
        id="delete-book-dialog"
        title="Eliminar Libro"
        description="¿Estás seguro de que deseas eliminar este libro del inventario? Esta acción no se puede deshacer."
      />
    </main>
  </div>
</Layout>

<script>
  import {
    subscribeToBooks,
    deleteBook,
    type Book,
  } from "../services/firebase/books";

  const tableBody = document.getElementById("books-table-body");
  const searchInput = document.getElementById(
    "book-search",
  ) as HTMLInputElement;
  let currentBooks: Book[] = [];

  // Render function
  const renderBooks = (books: Book[]) => {
    if (!tableBody) return;
    tableBody.innerHTML = "";

    if (books.length === 0) {
      tableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-8 text-[var(--m3-sys-on-surface-variant)]">
            No se encontraron libros.
          </td>
        </tr>
      `;
      return;
    }

    books.forEach((book) => {
      const row = document.createElement("tr");
      row.className =
        "hover:bg-[var(--m3-sys-surface-variant)]/20 transition-colors";
      row.innerHTML = `
        <td class="px-6 py-4 text-sm font-medium text-[var(--m3-sys-on-surface)]">
          ${book.title}
        </td>
        <td class="px-6 py-4 text-sm text-[var(--m3-sys-on-surface-variant)]">
          ${book.author}
        </td>
        <td class="px-6 py-4 text-sm text-[var(--m3-sys-on-surface-variant)]">
          ${book.isbn}
        </td>
        <td class="px-6 py-4 text-sm text-[var(--m3-sys-on-surface-variant)]">
          ${book.location}
        </td>
        <td class="px-6 py-4 text-sm">
          <span class="px-3 py-1 rounded-full text-xs font-semibold ${
            book.available > 0
              ? "bg-[var(--m3-sys-primary-container)] text-[var(--m3-sys-on-primary-container)]"
              : "bg-[var(--m3-sys-error-container)] text-[var(--m3-sys-on-error-container)]"
          }">
            ${book.available} Disp.
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-[var(--m3-sys-on-surface-variant)]">
          ${book.copies}
        </td>
        <td class="px-6 py-4 text-sm">
          <div class="flex items-center gap-2">
            <button
              class="p-2 text-[var(--m3-sys-primary)] hover:bg-[var(--m3-sys-primary)]/10 rounded-full transition-colors edit-btn"
              data-book='${JSON.stringify(book).replace(/'/g, "&#39;")}'
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></svg>
            </button>
            <button
              class="p-2 text-[var(--m3-sys-error)] hover:bg-[var(--m3-sys-error)]/10 rounded-full transition-colors delete-btn"
              data-id="${book.id}"
              data-title="${book.title}"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /></svg>
            </button>
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });

    // Attach event listeners to new buttons
    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const bookData = JSON.parse((btn as HTMLElement).dataset.book || "{}");
        // @ts-ignore
        window.openEditBookSidesheet();
        // @ts-ignore
        window.populateEditBookForm(bookData);
      });
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = (btn as HTMLElement).dataset.id;
        const title = (btn as HTMLElement).dataset.title;
        const dialog = document.getElementById(
          "delete-book-dialog",
        ) as HTMLDialogElement;
        if (dialog && id) {
          dialog.showModal();
          // @ts-ignore
          window.setOnConfirmDeleteBookDialog(async () => {
            try {
              await deleteBook(id);
              console.log(`Deleted book: ${title}`);
            } catch (e) {
              console.error("Error deleting book", e);
              alert("Error al eliminar el libro");
            }
          });
        }
      });
    });
  };

  // Subscribe to changes
  subscribeToBooks((books) => {
    currentBooks = books;
    renderBooks(books);
  });

  // Search Logic
  searchInput?.addEventListener("input", (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const filtered = currentBooks.filter(
      (book) =>
        book.title.toLowerCase().includes(query) ||
        book.author.toLowerCase().includes(query) ||
        book.isbn.toLowerCase().includes(query),
    );
    renderBooks(filtered);
  });
</script>
