---
import Layout from "../layouts/Layout.astro";
import Sidebar from "../components/Sidebar.astro";
import MobileHeader from "../components/MobileHeader.astro";
import LoanTable from "../features/dashboard/LoanTable.astro";
import Card from "../components/ui/Card.astro";
import EditLoanSideSheet from "../features/dashboard/EditLoanSideSheet.astro";
import ReturnLoanSideSheet from "../features/dashboard/ReturnLoanSideSheet.astro";
import ConfirmDeleteDialog from "../components/ui/ConfirmDeleteDialog.astro";
---

<Layout
  title="Historial de Préstamos | Biblioteca Digital"
  description="Consulta el historial completo de préstamos y devoluciones."
>
  <div
    class="flex flex-col lg:flex-row min-h-screen bg-[var(--m3-sys-light-surface)]"
  >
    <!-- Mobile Header -->
    <MobileHeader />

    <Sidebar />

    <main class="flex-1 p-4 lg:p-8 h-auto lg:h-screen overflow-y-auto">
      <div class="flex flex-col gap-6 mb-8">
        <div
          class="flex flex-col sm:flex-row sm:items-center justify-between gap-4"
        >
          <div class="flex flex-col gap-1">
            <h1
              class="text-2xl lg:text-3xl font-normal text-[var(--m3-sys-on-surface)]"
            >
              Historial
            </h1>
          </div>
        </div>

        <div class="flex flex-col gap-4">
          <div class="w-full max-w-sm">
            <div class="relative">
              <input
                type="text"
                id="search-input"
                placeholder="Buscar por libro, alumno o matrícula..."
                class="w-full pl-10 pr-4 py-2.5 rounded-[var(--m3-radius-xl)] bg-[var(--m3-sys-surface-variant)]/30 text-[var(--m3-sys-on-surface)] border-none outline-none focus:ring-2 focus:ring-[var(--m3-sys-primary)]/50 placeholder:text-[var(--m3-sys-on-surface-variant)]/50 transition-all"
              />
              <div
                class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--m3-sys-on-surface-variant)]"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><circle cx="11" cy="11" r="8"></circle><line
                    x1="21"
                    y1="21"
                    x2="16.65"
                    y2="16.65"></line></svg
                >
              </div>
            </div>
          </div>

          <div>
            <label
              class="text-xs font-medium text-[var(--m3-sys-on-surface-variant)] px-1 mb-2 block"
            >
              Filtrar por
            </label>
            <div
              class="flex gap-2 overflow-x-auto pb-2 scrollbar-none"
              id="filter-chips"
            >
              <button
                class="filter-chip active flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="all"
              >
                Todos
              </button>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="pending"
              >
                Pendientes
              </button>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="Activo"
              >
                Activos
              </button>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="Vencido"
              >
                Vencidos
              </button>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="Devuelto"
              >
                Devueltos
              </button>
              <div class="w-[1px] h-6 bg-[var(--m3-sys-outline)]/20 mx-1"></div>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="week"
              >
                Esta Semana
              </button>
              <button
                class="filter-chip flex items-center gap-2 px-4 py-1.5 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] text-sm font-medium transition-all hover:bg-[var(--m3-sys-surface-variant)]/30 whitespace-nowrap"
                data-filter="month"
              >
                Este Mes
              </button>
            </div>
          </div>
        </div>
      </div>

      <Card variant="outlined" class="!p-0 border-none mt-8">
        <LoanTable />
      </Card>

      <!-- Empty State -->
      <div
        id="empty-state"
        class="hidden flex-col items-center justify-center py-12 text-center"
      >
        <div
          class="w-16 h-16 bg-[var(--m3-sys-surface-variant)]/30 rounded-full flex items-center justify-center mb-4"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-[var(--m3-sys-on-surface-variant)] opacity-50"
            ><circle cx="11" cy="11" r="8"></circle><line
              x1="21"
              y1="21"
              x2="16.65"
              y2="16.65"></line></svg
          >
        </div>
        <h3 class="text-lg font-medium text-[var(--m3-sys-on-surface)]">
          No se encontraron resultados
        </h3>
      </div>
    </main>
    <EditLoanSideSheet />
    <ReturnLoanSideSheet />
    <ConfirmDeleteDialog
      id="delete-loan-dialog"
      title="Eliminar Préstamo"
      description="¿Estás seguro de que deseas eliminar este registro de préstamo? Esta acción no se puede deshacer."
    />
  </div>
</Layout>

<style>
  .scrollbar-none::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-none {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .filter-chip.active {
    background-color: var(--m3-sys-secondary-container);
    color: var(--m3-sys-on-secondary-container);
    border-color: transparent;
  }

  .filter-chip:not(.active) {
    background-color: transparent;
    border-color: var(--m3-sys-outline);
  }
</style>

<script>
  function setupHistoryFilters() {
    const searchInput = document.getElementById(
      "search-input",
    ) as HTMLInputElement;
    const filterChips = document.querySelectorAll(".filter-chip");
    const emptyState = document.getElementById("empty-state");

    // "All" by default for History
    let currentFilter = "all";
    let currentSearch = "";

    // Rows list is dynamic now
    let tableRows: NodeListOf<Element>;

    function updateTableRows() {
      tableRows = document.querySelectorAll("#loan-table tbody tr");
      // Re-apply filters when rows update
      filterTable();
    }

    // Force 'All' chip to be active initially
    filterChips.forEach((c) => {
      if (c.getAttribute("data-filter") === "all") {
        c.classList.add("active");
        c.setAttribute("aria-pressed", "true");
      } else {
        c.classList.remove("active");
        c.setAttribute("aria-pressed", "false");
      }
    });

    function filterTable() {
      if (!tableRows) return;

      let visibleCount = 0;
      const now = new Date();

      tableRows.forEach((row) => {
        const status = row.getAttribute("data-status");
        const dateStr = row.getAttribute("data-date");
        const content = row.getAttribute("data-content");
        const rowDate = dateStr ? new Date(dateStr) : null;

        let matchesFilter = false;

        if (currentFilter === "all") {
          matchesFilter = true;
        } else if (currentFilter === "pending") {
          matchesFilter = status !== "Devuelto";
        } else if (["Activo", "Vencido", "Devuelto"].includes(currentFilter)) {
          matchesFilter = status === currentFilter;
        } else if (currentFilter === "week") {
          const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          matchesFilter = rowDate ? rowDate >= oneWeekAgo : false;
        } else if (currentFilter === "month") {
          const oneMonthAgo = new Date(
            now.getTime() - 30 * 24 * 60 * 60 * 1000,
          );
          matchesFilter = rowDate ? rowDate >= oneMonthAgo : false;
        }

        const matchesSearch =
          currentSearch === "" || (content && content.includes(currentSearch));

        if (matchesFilter && matchesSearch) {
          (row as HTMLElement).style.display = "";
          visibleCount++;
        } else {
          (row as HTMLElement).style.display = "none";
        }
      });

      if (emptyState) {
        if (visibleCount === 0) {
          emptyState.classList.remove("hidden");
          emptyState.classList.add("flex");
        } else {
          emptyState.classList.add("hidden");
          emptyState.classList.remove("flex");
        }
      }
    }

    searchInput?.addEventListener("input", (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      filterTable();
    });

    filterChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        filterChips.forEach((c) => {
          c.classList.remove("active");
          c.setAttribute("aria-pressed", "false");
        });
        chip.classList.add("active");
        chip.setAttribute("aria-pressed", "true");

        currentFilter = chip.getAttribute("data-filter") || "all";
        filterTable();
      });
    });

    // Listen to loans-updated event from LoanTable
    window.addEventListener("loans-updated", updateTableRows);

    // Initial run in case rows are already there (sync render?)
    updateTableRows();
  }

  setupHistoryFilters();
  document.addEventListener("astro:page-load", setupHistoryFilters);
</script>
