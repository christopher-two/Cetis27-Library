---
import Skeleton from "../ui/Skeleton.astro";
---

<div
  id="book-category-chart"
  class="w-full h-full min-h-[300px] flex items-center justify-center overflow-hidden"
>
  <div
    id="book-category-loading"
    class="w-full flex items-center justify-center p-4"
  >
    <div class="aspect-square w-[200px] max-w-full">
      <Skeleton width="100%" height="100%" rounded="full" />
    </div>
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";

  let chart: ApexCharts | null = null;

  // Define color palettes
  // Define color palettes
  const lightModeColors = [
    "#B71C1C",
    "#C62828",
    "#880E4F",
    "#BF360C",
    "#4A148C",
    "#E65100",
  ]; // Dark Reds/Oranges/Pinks for Light Mode
  const darkModeColors = [
    "#EF9A9A",
    "#FFAB91",
    "#F48FB1",
    "#FFCC80",
    "#CE93D8",
    "#FFAB40",
  ]; // Pastel Reds/Oranges/Pinks for Dark Mode

  const getThemeColors = () => {
    return document.documentElement.classList.contains("dark")
      ? darkModeColors
      : lightModeColors;
  };

  const options = {
    series: [], // Initial empty state
    labels: [],
    chart: {
      width: "100%",
      type: "donut",
      fontFamily: "inherit",
      background: "transparent",
    },
    dataLabels: {
      enabled: false,
    },
    plotOptions: {
      pie: {
        donut: {
          labels: {
            show: true,
            total: {
              show: true,
              label: "Total",
              color: "var(--m3-sys-on-surface)",
              formatter: function (w: any) {
                return w.globals.seriesTotals.reduce((a: any, b: any) => {
                  return a + b;
                }, 0);
              },
            },
            value: {
              color: "var(--m3-sys-on-surface)",
              fontSize: "24px",
              fontWeight: 600,
            },
          },
        },
      },
    },
    stroke: {
      show: false,
    },
    legend: {
      position: "bottom",
      labels: {
        colors: "var(--m3-sys-on-surface)",
      },
    },
    colors: getThemeColors(),
    tooltip: {
      theme: "dark",
    },
    noData: {
      text: " ",
      align: "center",
      verticalAlign: "middle",
      style: {
        color: "var(--m3-sys-on-surface)",
        fontSize: "16px",
      },
    },
  };

  function renderChart() {
    const chartElement = document.querySelector("#book-category-chart");
    if (chartElement && !chart) {
      options.colors = getThemeColors();
      chart = new ApexCharts(chartElement, options);
      chart.render();
      setupThemeObserver();
    }
  }

  let observer: MutationObserver | null = null;
  function setupThemeObserver() {
    if (observer) return;

    observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class"
        ) {
          if (chart) {
            chart.updateOptions({
              colors: getThemeColors(),
            });
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }

  function updateChart(event: CustomEvent) {
    if (!chart) return;

    const loadingEl = document.getElementById("book-category-loading");
    if (loadingEl) loadingEl.style.display = "none";

    const categoriesData = event.detail;
    const labels = Object.keys(categoriesData);
    const series = Object.values(categoriesData) as number[];

    chart.updateOptions({
      labels: labels,
      series: series,
    });
  }

  renderChart();
  document.addEventListener("astro:page-load", () => {
    if (observer) {
      observer.disconnect();
      observer = null;
    }
    chart = null; // Reset chart instance on page load
    renderChart();
  });

  window.addEventListener(
    "dashboard-books-updated",
    updateChart as EventListener,
  );
</script>
