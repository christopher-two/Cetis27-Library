---
import Skeleton from "../ui/Skeleton.astro";
---

<div
  id="book-category-chart"
  class="w-full h-full min-h-[300px] flex items-center justify-center overflow-hidden"
>
  <div
    id="book-category-loading"
    class="w-full flex items-center justify-center p-4"
  >
    <div class="aspect-square w-[200px] max-w-full">
      <Skeleton width="100%" height="100%" rounded="full" />
    </div>
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";

  let chart: ApexCharts | null = null;

  const options = {
    series: [], // Initial empty state
    labels: [],
    chart: {
      width: "100%",
      type: "donut",
      fontFamily: "inherit",
    },
    dataLabels: {
      enabled: false,
    },
    plotOptions: {
      pie: {
        donut: {
          labels: {
            show: true,
            total: {
              show: true,
              label: "Total",
              color: "var(--m3-sys-on-surface)",
              formatter: function (w: any) {
                return w.globals.seriesTotals.reduce((a: any, b: any) => {
                  return a + b;
                }, 0);
              },
            },
            value: {
              color: "var(--m3-sys-on-surface)",
              fontSize: "24px",
              fontWeight: 600,
            },
          },
        },
      },
    },
    stroke: {
      show: false,
    },
    legend: {
      position: "bottom",
      labels: {
        colors: "var(--m3-sys-on-surface)",
      },
    },
    colors: ["#1565C0", "#42A5F5", "#90CAF9", "#1E88E5", "#0D47A1", "#64B5F6"], // Expanded palette
    tooltip: {
      theme: "dark",
    },
    noData: {
      text: " ",
      align: "center",
      verticalAlign: "middle",
      style: {
        color: "var(--m3-sys-on-surface)",
        fontSize: "16px",
      },
    },
  };

  function renderChart() {
    const chartElement = document.querySelector("#book-category-chart");
    if (chartElement && !chart) {
      chart = new ApexCharts(chartElement, options);
      chart.render();
    }
  }

  function updateChart(event: CustomEvent) {
    if (!chart) return;

    const loadingEl = document.getElementById("book-category-loading");
    if (loadingEl) loadingEl.style.display = "none";

    const categoriesData = event.detail;
    const labels = Object.keys(categoriesData);
    const series = Object.values(categoriesData) as number[];

    chart.updateOptions({
      labels: labels,
      series: series,
    });
  }

  renderChart();
  document.addEventListener("astro:page-load", () => {
    chart = null; // Reset chart instance on page load
    renderChart();
  });

  window.addEventListener(
    "dashboard-books-updated",
    updateChart as EventListener,
  );
</script>
