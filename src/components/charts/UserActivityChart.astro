---
import Skeleton from "../ui/Skeleton.astro";
---

<div id="user-activity-chart" class="w-full h-full min-h-[300px]">
  <div id="user-activity-loading" class="w-full h-full flex flex-col gap-6 p-4">
    <div class="grid grid-cols-7 gap-4 items-end h-[200px] w-full px-2">
      <Skeleton width="100%" height="60%" />
      <Skeleton width="100%" height="40%" />
      <Skeleton width="100%" height="80%" />
      <Skeleton width="100%" height="50%" />
      <Skeleton width="100%" height="70%" />
      <Skeleton width="100%" height="90%" />
      <Skeleton width="100%" height="45%" />
    </div>
    <div class="grid grid-cols-7 gap-4 w-full px-2">
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
      <Skeleton width="100%" height="12px" />
    </div>
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";

  let chart: ApexCharts | null = null;

  const options = {
    series: [], // Initial empty state
    chart: {
      type: "bar",
      height: 350,
      stacked: true,
      toolbar: {
        show: false,
      },
      zoom: {
        enabled: false,
      },
    },
    responsive: [
      {
        breakpoint: 480,
        options: {
          legend: {
            position: "bottom",
            offsetX: -10,
            offsetY: 0,
          },
        },
      },
    ],
    plotOptions: {
      bar: {
        horizontal: false,
        borderRadius: 4,
        dataLabels: {
          total: {
            enabled: true,
            style: {
              fontSize: "13px",
              fontWeight: 900,
            },
          },
        },
      },
    },
    xaxis: {
      categories: ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
      axisBorder: { show: false },
      axisTicks: { show: false },
    },
    yaxis: {
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
    },
    legend: {
      position: "right",
      offsetY: 40,
      labels: {
        colors: "var(--m3-sys-on-surface)",
      },
    },
    fill: {
      opacity: 1,
    },
    colors: ["#2196F3", "#BBDEFB"],
    grid: {
      borderColor: "var(--m3-sys-outline-variant)",
      strokeDashArray: 4,
    },
    tooltip: {
      theme: "dark",
    },
    noData: {
      text: " ",
      align: "center",
      verticalAlign: "middle",
      style: {
        color: "var(--m3-sys-on-surface)",
        fontSize: "16px",
      },
    },
  };

  function renderChart() {
    const chartElement = document.querySelector("#user-activity-chart");
    if (chartElement && !chart) {
      chart = new ApexCharts(chartElement, options);
      chart.render();
    }
  }

  function updateChart(event: CustomEvent) {
    if (!chart) return;

    const loadingEl = document.getElementById("user-activity-loading");
    if (loadingEl) loadingEl.style.display = "none";

    const { loans } = event.detail.activity;
    if (!loans) return;

    // Initialize days array (0=Sunday to 6=Saturday) but usually we want Mon-Sun
    // Lets stick to what categories says: Lun-Dom (0-6 index)
    // JS getDay() returns 0 for Sunday.
    const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
    // But chart categories are: Lun, Mar, Mié... Dom (7 items)
    // So let's map JS day 1->0, 2->1 ... 0->6

    const getDayIndex = (dateStr: string) => {
      const day = new Date(dateStr).getDay(); // 0 is Sunday
      return day === 0 ? 6 : day - 1;
    };

    const activeCounts = [0, 0, 0, 0, 0, 0, 0];
    const newCounts = [0, 0, 0, 0, 0, 0, 0];

    loans.forEach((loan: any) => {
      // New loans based on loanDate
      if (loan.loanDate) {
        const idx = getDayIndex(loan.loanDate);
        if (idx >= 0 && idx <= 6) newCounts[idx]++;
      }
      // Active items (this logic is a bit fuzzy for "Activity", usually implies checkouts/checkins)
      // Let's count checkins as "Activos" (or completed activity) or just use current active loans distribution
      // For "Actividad", let's say "Préstamos" vs "Devoluciones" per day of week

      if (loan.returnDate) {
        const idx = getDayIndex(loan.loanDate); // Use return date if available?
        // logic in dashboard was: Activos vs Nuevos.
        // Let's stick to "Returned" vs "New" for activity
      }
    });

    // Recalculating simplification:
    // Series 1: "Préstamos" (New)
    // Series 2: "Devoluciones" (Returned)

    const loanCounts = [0, 0, 0, 0, 0, 0, 0];
    const returnCounts = [0, 0, 0, 0, 0, 0, 0];

    loans.forEach((loan: any) => {
      if (loan.loanDate) {
        const idx = getDayIndex(loan.loanDate);
        if (idx >= 0) loanCounts[idx]++;
      }
      if (loan.returnDate && loan.status === "returned") {
        const idx = getDayIndex(loan.returnDate);
        if (idx >= 0) returnCounts[idx]++;
      }
    });

    chart.updateSeries([
      {
        name: "Préstamos",
        data: loanCounts,
      },
      {
        name: "Devoluciones",
        data: returnCounts,
      },
    ]);
  }

  renderChart();
  document.addEventListener("astro:page-load", () => {
    chart = null;
    renderChart();
  });
  window.addEventListener(
    "dashboard-loans-updated",
    updateChart as EventListener,
  );
</script>
