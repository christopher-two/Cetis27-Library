---
import Skeleton from "../ui/Skeleton.astro";
---

<div id="loans-trend-chart" class="w-full h-full min-h-[300px]">
  <div id="loans-trend-loading" class="w-full h-full flex flex-col gap-4 p-4">
    <div class="relative h-[200px] w-full overflow-hidden rounded-lg">
      <Skeleton width="100%" height="100%" class="opacity-20" />
      <div class="absolute inset-0 flex items-end px-2 gap-4">
        {
          [30, 50, 40, 70, 60, 85, 55].map((h) => (
            <Skeleton width="100%" height={`${h}%`} />
          ))
        }
      </div>
    </div>
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";

  let chart: ApexCharts | null = null;

  // Define color palettes
  const lightModeColors = ["#B71C1C", "#C62828"]; // Dark Reds for Light Mode
  const darkModeColors = ["#EF9A9A", "#E57373"]; // Light Reds for Dark Mode

  const getThemeColors = () => {
    return document.documentElement.classList.contains("dark")
      ? darkModeColors
      : lightModeColors;
  };

  const options = {
    series: [],
    chart: {
      height: 350,
      width: "100%",
      type: "area",
      fontFamily: "inherit",
      toolbar: {
        show: false,
      },
      animations: {
        enabled: true,
      },
      background: "transparent",
    },
    dataLabels: {
      enabled: false,
    },
    stroke: {
      curve: "smooth",
      width: 2,
    },
    xaxis: {
      type: "datetime",
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
      axisBorder: {
        show: false,
      },
      axisTicks: {
        show: false,
      },
    },
    yaxis: {
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
    },
    grid: {
      borderColor: "var(--m3-sys-outline-variant)",
      strokeDashArray: 4,
      yaxis: {
        lines: {
          show: true,
        },
      },
    },
    tooltip: {
      theme: "dark",
      x: {
        format: "dd MMM yyyy",
      },
    },
    colors: getThemeColors(),
    fill: {
      type: "gradient",
      gradient: {
        shadeIntensity: 1,
        opacityFrom: 0.7,
        opacityTo: 0.2,
        stops: [0, 90, 100],
      },
    },
    legend: {
      labels: {
        colors: "var(--m3-sys-on-surface)",
      },
    },
    noData: {
      text: " ",
      align: "center",
      verticalAlign: "middle",
      style: {
        color: "var(--m3-sys-on-surface)",
        fontSize: "16px",
      },
    },
  };

  function renderChart() {
    const chartElement = document.querySelector("#loans-trend-chart");
    if (chartElement && !chart) {
      options.colors = getThemeColors(); // Ensure correct colors on render
      chart = new ApexCharts(chartElement, options);
      chart.render();

      // Setup theme observer
      setupThemeObserver();
    }
  }

  let observer: MutationObserver | null = null;
  function setupThemeObserver() {
    if (observer) return; // Recently setup

    observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class"
        ) {
          if (chart) {
            chart.updateOptions({
              colors: getThemeColors(),
            });
          }
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  }

  function updateChart(event: CustomEvent) {
    if (!chart) return;

    const loadingEl = document.getElementById("loans-trend-loading");
    if (loadingEl) loadingEl.style.display = "none";

    const { loans } = event.detail.trends;
    if (!loans) return;

    // Process loans to get counts by date (last 7 days example)
    const last7Days = [...Array(7)].map((_, i) => {
      const d = new Date();
      d.setDate(d.getDate() - (6 - i));
      return d.toISOString().split("T")[0];
    });

    const loanedData = last7Days.map((date) => ({
      x: date,
      y: loans.filter((l: any) => l.loanDate === date).length,
    }));

    const returnedData = last7Days.map((date) => ({
      x: date,
      y: loans.filter(
        (l: any) => l.returnDate === date && l.status === "returned",
      ).length,
    }));

    chart.updateSeries([
      {
        name: "PrÃ©stamos",
        data: loanedData,
      },
      {
        name: "Devoluciones",
        data: returnedData,
      },
    ]);
  }

  renderChart();
  document.addEventListener("astro:page-load", () => {
    if (observer) {
      observer.disconnect();
      observer = null;
    }
    chart = null;
    renderChart();
  });
  window.addEventListener(
    "dashboard-loans-updated",
    updateChart as EventListener,
  );
</script>
