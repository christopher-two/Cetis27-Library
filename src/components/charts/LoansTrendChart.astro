---
import Skeleton from "../ui/Skeleton.astro";
---

<div id="loans-trend-chart" class="w-full h-full min-h-[300px]">
  <div id="loans-trend-loading" class="w-full h-full flex flex-col gap-4 p-4">
    <div class="relative h-[200px] w-full overflow-hidden rounded-lg">
      <Skeleton width="100%" height="100%" class="opacity-20" />
      <div class="absolute inset-0 flex items-end px-2 gap-4">
        <Skeleton width="10%" height="30%" />
        <Skeleton width="10%" height="50%" />
        <Skeleton width="10%" height="40%" />
        <Skeleton width="10%" height="70%" />
        <Skeleton width="10%" height="60%" />
        <Skeleton width="10%" height="85%" />
        <Skeleton width="10%" height="55%" />
      </div>
    </div>
  </div>
</div>

<script>
  import ApexCharts from "apexcharts";

  let chart: ApexCharts | null = null;

  const options = {
    series: [],
    chart: {
      height: 350,
      type: "area",
      fontFamily: "inherit",
      toolbar: {
        show: false,
      },
      animations: {
        enabled: true,
      },
    },
    dataLabels: {
      enabled: false,
    },
    stroke: {
      curve: "smooth",
      width: 2,
    },
    xaxis: {
      type: "datetime",
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
      axisBorder: {
        show: false,
      },
      axisTicks: {
        show: false,
      },
    },
    yaxis: {
      labels: {
        style: {
          colors: "var(--m3-sys-on-surface-variant)",
        },
      },
    },
    grid: {
      borderColor: "var(--m3-sys-outline-variant)",
      strokeDashArray: 4,
      yaxis: {
        lines: {
          show: true,
        },
      },
    },
    tooltip: {
      theme: "dark",
      x: {
        format: "dd MMM yyyy",
      },
    },
    colors: ["#64B5F6", "#1976D2"],
    fill: {
      type: "gradient",
      gradient: {
        shadeIntensity: 1,
        opacityFrom: 0.7,
        opacityTo: 0.2,
        stops: [0, 90, 100],
      },
    },
    legend: {
      labels: {
        colors: "var(--m3-sys-on-surface)",
      },
    },
    noData: {
      text: " ",
      align: "center",
      verticalAlign: "middle",
      style: {
        color: "var(--m3-sys-on-surface)",
        fontSize: "16px",
      },
    },
  };

  function renderChart() {
    const chartElement = document.querySelector("#loans-trend-chart");
    if (chartElement && !chart) {
      chart = new ApexCharts(chartElement, options);
      chart.render();
    }
  }

  function updateChart(event: CustomEvent) {
    if (!chart) return;

    const loadingEl = document.getElementById("loans-trend-loading");
    if (loadingEl) loadingEl.style.display = "none";

    const { loans } = event.detail.trends;
    if (!loans) return;

    // Process loans to get counts by date (last 7 days example)
    const last7Days = [...Array(7)].map((_, i) => {
      const d = new Date();
      d.setDate(d.getDate() - (6 - i));
      return d.toISOString().split("T")[0];
    });

    const loanedData = last7Days.map((date) => ({
      x: date,
      y: loans.filter((l: any) => l.loanDate === date).length,
    }));

    const returnedData = last7Days.map((date) => ({
      x: date,
      y: loans.filter(
        (l: any) => l.returnDate === date && l.status === "returned",
      ).length,
    }));

    chart.updateSeries([
      {
        name: "PrÃ©stamos",
        data: loanedData,
      },
      {
        name: "Devoluciones",
        data: returnedData,
      },
    ]);
  }

  renderChart();
  document.addEventListener("astro:page-load", () => {
    chart = null;
    renderChart();
  });
  window.addEventListener(
    "dashboard-loans-updated",
    updateChart as EventListener,
  );
</script>
