---
import SideSheet from "../../components/ui/SideSheet.astro";
import TextField from "../../components/ui/TextField.astro";
import Button from "../../components/ui/Button.astro";
---

<SideSheet id="edit-student-sidesheet" title="Editar Alumno">
  <form class="flex flex-col gap-8" id="edit-student-form">
    <input type="hidden" id="edit-student-id" />
    <div class="flex flex-col gap-5">
      <TextField
        label="Matrícula"
        placeholder="Ej. 20241050"
        required
        id="edit-student-matricula"
        readonly
      />

      <div class="grid grid-cols-1 gap-5">
        <TextField
          label="Nombre Completo"
          placeholder="Ej. Juan Pérez"
          required
          id="edit-student-name"
        />
        <TextField
          label="Correo Institucional"
          type="email"
          placeholder="Ej. juan.perez@edu.mx"
          required
          id="edit-student-email"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label
          class="text-sm font-medium text-[var(--m3-sys-on-surface-variant)] ml-1"
          >Carrera / Grado</label
        >
        <select
          id="edit-student-career"
          class="w-full px-4 py-3 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] bg-[var(--m3-sys-surface)] text-[var(--m3-sys-on-surface)] outline-none focus:border-[var(--m3-sys-primary)] transition-all"
        >
          <option value="" disabled>Selecciona una opción</option>
          <option value="construccion">Carrera Técnica en Construcción</option>
          <option value="contabilidad">Carrera Técnica en Contabilidad</option>
          <option value="electricidad">Carrera Técnica en Electricidad</option>
          <option value="electronica">Carrera Técnica en Electrónica</option>
          <option value="enfermeria"
            >Carrera Técnica en Enfermería General</option
          >
          <option value="programacion">Carrera Técnica en Programación</option>
          <option value="puericultura">Carrera Técnica en Puericultura</option>
          <option value="secretariado"
            >Carrera Técnica en Secretariado Ejecutivo Bilingüe</option
          >
        </select>
      </div>
    </div>

    <div class="flex flex-col gap-3 mt-4">
      <Button type="submit" class="w-full !py-4 shadow-lg text-base"
        >Guardar Cambios</Button
      >
      <Button
        variant="text"
        type="button"
        onclick="window.closeEditStudentSidesheet()"
        class="w-full">Cancelar</Button
      >
    </div>
  </form>
</SideSheet>

<script>
  import { updateStudent } from "../../services/firebase/students";

  const form = document.getElementById("edit-student-form");

  // @ts-ignore
  window.populateEditStudentForm = (student) => {
    (document.getElementById("edit-student-id") as HTMLInputElement).value =
      student.id;
    (
      document.getElementById("edit-student-matricula") as HTMLInputElement
    ).value = student.matricula || student.id;
    (document.getElementById("edit-student-name") as HTMLInputElement).value =
      student.name;
    (document.getElementById("edit-student-email") as HTMLInputElement).value =
      student.email || "";

    const careerSelect = document.getElementById(
      "edit-student-career",
    ) as HTMLSelectElement;
    if (careerSelect) {
      careerSelect.value = student.career;
    }
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = (document.getElementById("edit-student-id") as HTMLInputElement)
      .value;
    const name = (
      document.getElementById("edit-student-name") as HTMLInputElement
    ).value;
    const email = (
      document.getElementById("edit-student-email") as HTMLInputElement
    ).value;
    const career = (
      document.getElementById("edit-student-career") as HTMLSelectElement
    ).value;

    try {
      await updateStudent(id, {
        name,
        email,
        career,
      });
      // @ts-ignore
      window.closeEditStudentSidesheet();
    } catch (error) {
      console.error("Error updating student:", error);
      alert("Error al actualizar alumno.");
    }
  });
</script>
