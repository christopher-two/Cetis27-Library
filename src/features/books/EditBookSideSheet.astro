---
import SideSheet from "../../components/ui/SideSheet.astro";
import TextField from "../../components/ui/TextField.astro";
import Button from "../../components/ui/Button.astro";
---

<SideSheet id="edit-book-sidesheet" title="Editar Libro">
  <form class="flex flex-col gap-6" id="edit-book-form">
    <input type="hidden" id="edit-book-id" />
    <div class="flex flex-col gap-5">
      <TextField
        label="Título del Libro"
        placeholder="Ej. El Principito"
        required
        id="edit-book-title"
      />
      <TextField
        label="Autor"
        placeholder="Ej. Antoine de Saint-Exupéry"
        required
        id="edit-book-author"
      />
      <TextField
        label="ISBN"
        placeholder="Ej. 978-3-16-148410-0"
        required
        id="edit-book-isbn"
      />
      <div class="grid grid-cols-2 gap-4">
        <TextField
          label="Copias Totales"
          type="number"
          placeholder="Ej. 5"
          required
          id="edit-book-copies"
        />
        <TextField
          label="Ubicación"
          placeholder="Ej. Estante A-1"
          required
          id="edit-book-location"
        />
      </div>
    </div>

    <div class="flex flex-col gap-3 mt-4">
      <Button md-type="submit" class="w-full !py-4 shadow-lg text-base">
        Guardar Cambios
      </Button>
      <Button
        variant="text"
        onclick="window.closeEditBookSidesheet()"
        class="w-full">Cancelar</Button
      >
    </div>
  </form>
</SideSheet>

<script>
  import { updateBook } from "../../services/firebase/books";

  const form = document.getElementById("edit-book-form");

  // Function to populate the form (attached to window for global access)
  // @ts-ignore
  window.populateEditBookForm = (book) => {
    (document.getElementById("edit-book-id") as HTMLInputElement).value =
      book.id;
    (document.getElementById("edit-book-title") as HTMLInputElement).value =
      book.title;
    (document.getElementById("edit-book-author") as HTMLInputElement).value =
      book.author;
    (document.getElementById("edit-book-isbn") as HTMLInputElement).value =
      book.isbn;
    (document.getElementById("edit-book-copies") as HTMLInputElement).value =
      book.copies;
    (document.getElementById("edit-book-location") as HTMLInputElement).value =
      book.location;
  };

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = (document.getElementById("edit-book-id") as HTMLInputElement)
      .value;
    const title = (
      document.getElementById("edit-book-title") as HTMLInputElement
    ).value;
    const author = (
      document.getElementById("edit-book-author") as HTMLInputElement
    ).value;
    const isbn = (document.getElementById("edit-book-isbn") as HTMLInputElement)
      .value;
    const copies = parseInt(
      (document.getElementById("edit-book-copies") as HTMLInputElement).value,
    );
    const location = (
      document.getElementById("edit-book-location") as HTMLInputElement
    ).value;

    try {
      if (!id) throw new Error("No ID found for book");

      await updateBook(id, {
        title,
        author,
        isbn,
        copies,
        // Calculate available based on copies change? For simplicity, we might just update copies.
        // In a real app we'd check if available needs adjustment relative to new total.
        // For now, let's assume available stays as is or we'd need to fetch current.
        // But wait, we don't have 'available' in the form.
        // Let's just update the fields we have.
        location,
      });
      // @ts-ignore
      window.closeEditBookSidesheet();
      // Optional: Show success message
    } catch (error) {
      console.error("Error updating book:", error);
      alert("Error al actualizar el libro");
    }
  });
</script>
