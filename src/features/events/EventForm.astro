---
import {
  createEvent,
  updateEvent,
  type Event,
  type CustomField,
} from "../../services/firebase/events";

interface Props {
  event?: Event;
}

const { event } = Astro.props;
const isEditing = !!event;
---

<form
  id="event-form"
  class="space-y-8 w-full p-6 bg-[var(--m3-sys-surface)] rounded-xl shadow-sm border border-[var(--m3-sys-outline)]/20"
  data-event-id={event?.id}
  data-is-editing={isEditing}
>
  <div class="space-y-4">
    <h2 class="text-2xl font-bold text-[var(--m3-sys-on-surface)]">
      {isEditing ? "Editar Evento" : "Crear Nuevo Evento"}
    </h2>
    <p class="text-[var(--m3-sys-on-surface-variant)]">
      {
        isEditing
          ? "Modifica los detalles de tu evento."
          : "Configura todos los detalles de tu evento, incluyendo reglas y formulario de inscripci√≥n."
      }
    </p>

    <!-- Templates Section (Only show when NOT editing) -->
    {
      !isEditing && (
        <div class="pt-2 pb-4 border-b border-[var(--m3-sys-outline)]/20">
          <h3 class="text-sm font-semibold text-[var(--m3-sys-on-surface)] mb-3">
            Plantillas R√°pidas
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button
              type="button"
              class="template-btn p-4 rounded-lg border border-[var(--m3-sys-outline)]/20 hover:border-[var(--m3-sys-primary)] hover:bg-[var(--m3-sys-primary-container)]/10 transition-all text-left group"
              data-template="workshop"
            >
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xl">üõ†Ô∏è</span>
                <span class="font-medium text-[var(--m3-sys-on-surface)] group-hover:text-[var(--m3-sys-primary)]">
                  Taller Pr√°ctico
                </span>
              </div>
              <p class="text-xs text-[var(--m3-sys-on-surface-variant)]">
                Ideal para clases o sesiones de aprendizaje activo.
              </p>
            </button>

            <button
              type="button"
              class="template-btn p-4 rounded-lg border border-[var(--m3-sys-outline)]/20 hover:border-[var(--m3-sys-primary)] hover:bg-[var(--m3-sys-primary-container)]/10 transition-all text-left group"
              data-template="conference"
            >
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xl">üé§</span>
                <span class="font-medium text-[var(--m3-sys-on-surface)] group-hover:text-[var(--m3-sys-primary)]">
                  Conferencia
                </span>
              </div>
              <p class="text-xs text-[var(--m3-sys-on-surface-variant)]">
                Para charlas, presentaciones o paneles de expertos.
              </p>
            </button>

            <button
              type="button"
              class="template-btn p-4 rounded-lg border border-[var(--m3-sys-outline)]/20 hover:border-[var(--m3-sys-primary)] hover:bg-[var(--m3-sys-primary-container)]/10 transition-all text-left group"
              data-template="bookclub"
            >
              <div class="flex items-center gap-2 mb-1">
                <span class="text-xl">üìö</span>
                <span class="font-medium text-[var(--m3-sys-on-surface)] group-hover:text-[var(--m3-sys-primary)]">
                  Club de Lectura
                </span>
              </div>
              <p class="text-xs text-[var(--m3-sys-on-surface-variant)]">
                Reuniones peri√≥dicas para discutir un libro.
              </p>
            </button>
          </div>
        </div>
      )
    }
  </div>

  <!-- General Info -->
  <div class="space-y-4">
    <h3
      class="text-lg font-semibold text-[var(--m3-sys-on-surface)] border-b border-[var(--m3-sys-outline)]/20 pb-2"
    >
      Informaci√≥n General
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="space-y-2 lg:col-span-2">
        <label
          for="title"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >T√≠tulo del Evento</label
        >
        <input
          type="text"
          id="title"
          name="title"
          required
          value={event?.title || ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>

      <div class="space-y-2">
        <label
          for="location"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >Ubicaci√≥n</label
        >
        <input
          type="text"
          id="location"
          name="location"
          required
          value={event?.location || ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>

      <div class="space-y-2">
        <label
          for="startDate"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >Fecha de Inicio</label
        >
        <input
          type="datetime-local"
          id="startDate"
          name="startDate"
          required
          value={event?.startDate
            ? new Date(event.startDate).toISOString().slice(0, 16)
            : ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>

      <div class="space-y-2">
        <label
          for="endDate"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >Fecha de Fin</label
        >
        <input
          type="datetime-local"
          id="endDate"
          name="endDate"
          required
          value={event?.endDate
            ? new Date(event.endDate).toISOString().slice(0, 16)
            : ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>

      <div class="space-y-2">
        <label
          for="capacity"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >Capacidad M√°xima</label
        >
        <input
          type="number"
          id="capacity"
          name="capacity"
          min="1"
          required
          value={event?.capacity || ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>

      <div class="space-y-2 lg:col-span-3">
        <label
          for="bannerUrl"
          class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
          >URL del Banner (Opcional)</label
        >
        <input
          type="url"
          id="bannerUrl"
          name="bannerUrl"
          placeholder="https://..."
          value={event?.bannerUrl || ""}
          class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        />
      </div>
    </div>

    <div class="space-y-2">
      <label
        for="description"
        class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
        >Descripci√≥n</label
      >
      <textarea
        id="description"
        name="description"
        rows="4"
        required
        class="w-full px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none transition-all bg-transparent text-[var(--m3-sys-on-surface)]"
        >{event?.description || ""}</textarea
      >
    </div>
  </div>

  <!-- Policies -->
  <div class="space-y-4">
    <h3
      class="text-lg font-semibold text-[var(--m3-sys-on-surface)] border-b border-[var(--m3-sys-outline)]/20 pb-2"
    >
      Reglas y Requisitos
    </h3>

    <div class="space-y-2">
      <label
        class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
        >Reglas del Evento</label
      >
      <div id="rules-container" class="space-y-2">
        <!-- Dynamic Rules Inputs -->
        {
          event?.rules?.map((rule) => (
            <div class="flex gap-2">
              <input
                type="text"
                value={rule}
                class="flex-1 px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none bg-transparent text-[var(--m3-sys-on-surface)]"
                placeholder="Escribe una regla..."
              />
              <button
                type="button"
                class="text-[var(--m3-sys-error)] hover:opacity-80 px-2 remove-btn"
              >
                ‚úï
              </button>
            </div>
          ))
        }
      </div>
      <button
        type="button"
        id="add-rule-btn"
        class="text-sm text-[var(--m3-sys-primary)] hover:opacity-80 font-medium flex items-center gap-1"
      >
        + A√±adir Regla
      </button>
    </div>

    <div class="space-y-2">
      <label
        class="block text-sm font-medium text-[var(--m3-sys-on-surface-variant)]"
        >Requisitos para Asistentes</label
      >
      <div id="requirements-container" class="space-y-2">
        <!-- Dynamic Requirements Inputs -->
        {
          event?.requirements?.map((req) => (
            <div class="flex gap-2">
              <input
                type="text"
                value={req}
                class="flex-1 px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none bg-transparent text-[var(--m3-sys-on-surface)]"
                placeholder="Escribe un requisito..."
              />
              <button
                type="button"
                class="text-[var(--m3-sys-error)] hover:opacity-80 px-2 remove-btn"
              >
                ‚úï
              </button>
            </div>
          ))
        }
      </div>
      <button
        type="button"
        id="add-req-btn"
        class="text-sm text-[var(--m3-sys-primary)] hover:opacity-80 font-medium flex items-center gap-1"
      >
        + A√±adir Requisito
      </button>
    </div>
  </div>

  <!-- Custom Registration Form -->
  <div class="space-y-4">
    <div
      class="flex justify-between items-center border-b border-[var(--m3-sys-outline)]/20 pb-2"
    >
      <h3 class="text-lg font-semibold text-[var(--m3-sys-on-surface)]">
        Formulario de Inscripci√≥n Personalizado
      </h3>
      <button
        type="button"
        id="add-field-btn"
        class="px-3 py-1 bg-[var(--m3-sys-surface-variant)] hover:opacity-80 text-[var(--m3-sys-on-surface-variant)] text-sm rounded-lg transition-colors"
      >
        A√±adir Campo
      </button>
    </div>
    <p class="text-sm text-[var(--m3-sys-on-surface-variant)]">
      Define qu√© preguntas deben responder los usuarios al inscribirse (ej.
      Talla de camiseta, Alergias).
    </p>

    <div id="custom-fields-container" class="space-y-4">
      <!-- Dynamic Custom Fields -->
    </div>
  </div>

  <!-- Actions -->
  <div
    class="pt-6 flex justify-between items-center border-t border-[var(--m3-sys-outline)]/20"
  >
    <div class="flex gap-3">
      {
        isEditing && (
          <button
            type="button"
            id="delete-btn"
            class="px-6 py-2 border border-[var(--m3-sys-error)] text-[var(--m3-sys-error)] rounded-lg hover:bg-[var(--m3-sys-error)]/10 transition-colors"
          >
            Eliminar
          </button>
        )
      }
      <button
        type="button"
        id="cancel-btn"
        class="px-6 py-2 border border-[var(--m3-sys-outline)] text-[var(--m3-sys-on-surface-variant)] rounded-lg hover:bg-[var(--m3-sys-surface-variant)]/10 transition-colors"
      >
        Cancelar
      </button>
    </div>
    <button
      type="submit"
      class="px-6 py-2 bg-[var(--m3-sys-primary)] text-[var(--m3-sys-on-primary)] rounded-lg hover:opacity-90 shadow-md hover:shadow-lg transition-all"
    >
      {isEditing ? "Guardar Cambios" : "Crear Evento"}
    </button>
  </div>
</form>

<!-- Pass custom fields data to JS if editing -->
<div
  id="initial-custom-fields"
  data-fields={JSON.stringify(event?.customFields || [])}
  class="hidden"
>
</div>

<!-- Delete Confirmation Dialog -->
<dialog
  id="delete-confirmation-dialog"
  class="bg-transparent p-0 backdrop:bg-black/50 backdrop:backdrop-blur-sm"
>
  <div
    class="bg-[var(--m3-sys-surface)] p-6 rounded-2xl shadow-2xl border border-[var(--m3-sys-outline)]/20 max-w-sm w-full mx-4"
  >
    <h3 class="text-xl font-bold text-[var(--m3-sys-on-surface)] mb-2">
      ¬øEliminar Evento?
    </h3>
    <p class="text-[var(--m3-sys-on-surface-variant)] mb-6 text-sm">
      Esta acci√≥n no se puede deshacer. El evento y todos sus datos se perder√°n
      permanentemente.
    </p>
    <div class="flex justify-end gap-3">
      <button
        id="cancel-delete-dialog-btn"
        class="px-4 py-2 text-[var(--m3-sys-primary)] font-medium hover:bg-[var(--m3-sys-surface-variant)]/30 rounded-lg transition-colors"
      >
        Cancelar
      </button>
      <button
        id="confirm-delete-dialog-btn"
        class="px-4 py-2 bg-[var(--m3-sys-error)] text-[var(--m3-sys-on-error)] font-medium rounded-lg hover:shadow-lg hover:opacity-90 transition-all"
      >
        Eliminar
      </button>
    </div>
  </div>
</dialog>

<script>
  import {
    createEvent,
    updateEvent,
    deleteEvent,
    type CustomField,
  } from "../../services/firebase/events";
  import { auth } from "../../lib/firebase";

  const form = document.getElementById("event-form") as HTMLFormElement;
  const rulesContainer = document.getElementById("rules-container");
  const requirementsContainer = document.getElementById(
    "requirements-container",
  );
  const customFieldsContainer = document.getElementById(
    "custom-fields-container",
  );
  const cancelBtn = document.getElementById("cancel-btn");
  const deleteBtn = document.getElementById("delete-btn");

  // Initialize existing remove buttons
  document.querySelectorAll(".remove-btn").forEach((btn) => {
    btn.addEventListener("click", function (this: HTMLButtonElement) {
      this.parentElement?.remove();
    });
  });

  if (cancelBtn) {
    cancelBtn.onclick = () => history.back();
  }

  if (deleteBtn) {
    const deleteDialog = document.getElementById(
      "delete-confirmation-dialog",
    ) as HTMLDialogElement;
    const cancelDeleteDialogBtn = document.getElementById(
      "cancel-delete-dialog-btn",
    );
    const confirmDeleteDialogBtn = document.getElementById(
      "confirm-delete-dialog-btn",
    );

    deleteBtn.onclick = () => {
      deleteDialog?.showModal();
    };

    cancelDeleteDialogBtn?.addEventListener("click", () => {
      deleteDialog?.close();
    });

    confirmDeleteDialogBtn?.addEventListener("click", async () => {
      const form = document.getElementById("event-form") as HTMLFormElement;
      const eventId = form.dataset.eventId;

      if (eventId) {
        // Change button state to loading
        if (confirmDeleteDialogBtn) {
          confirmDeleteDialogBtn.textContent = "Eliminando...";
          (confirmDeleteDialogBtn as HTMLButtonElement).disabled = true;
        }

        try {
          await deleteEvent(eventId);
          alert("Evento eliminado correctamente"); // Keep accessible alert for success
          window.location.href = "/events";
        } catch (error) {
          console.error(error);
          alert("Error al eliminar el evento: " + (error as Error).message);
          deleteDialog?.close();
          // Reset button
          if (confirmDeleteDialogBtn) {
            confirmDeleteDialogBtn.textContent = "Eliminar";
            (confirmDeleteDialogBtn as HTMLButtonElement).disabled = false;
          }
        }
      }
    });

    // Close on backdrop click
    deleteDialog?.addEventListener("click", (e) => {
      const rect = deleteDialog.getBoundingClientRect();
      const isInDialog =
        rect.top <= e.clientY &&
        e.clientY <= rect.top + rect.height &&
        rect.left <= e.clientX &&
        e.clientX <= rect.left + rect.width;
      if (!isInDialog) {
        deleteDialog.close();
      }
    });
  }

  // --- TEMPLATES DATA ---
  const EVENT_TEMPLATES = {
    workshop: {
      title: "Taller de [Tema]",
      description:
        "√önete a este taller pr√°ctico donde aprenderemos sobre [Habilidad]. No se requiere experiencia previa, solo ganas de aprender. Incluye materiales.",
      capacity: 20,
      rules: [
        "Llegar 10 minutos antes",
        "Traer computadora port√°til",
        "Mantener el celular en silencio",
      ],
      requirements: ["Mayor de 15 a√±os", "Conocimientos b√°sicos de PC"],
      customFields: [
        {
          label: "¬øTienes experiencia previa en este tema?",
          type: "select",
          required: true,
          options: "S√≠, No, Un poco",
        },
        {
          label: "¬øQu√© esperas aprender?",
          type: "text",
          required: false,
        },
      ],
    },
    conference: {
      title: "Conferencia: [T√≠tulo de la Charla]",
      description:
        "Una conferencia magistral impartida por expertos en el campo de [Campo]. Concluiremos con una sesi√≥n de preguntas y respuestas.",
      capacity: 100,
      rules: ["Respetar el turno de preguntas", "No grabar sin permiso"],
      requirements: ["Entrada libre", "Registro previo obligatorio"],
      customFields: [
        {
          label: "¬øC√≥mo te enteraste del evento?",
          type: "select",
          required: true,
          options: "Redes Sociales, Amigo, Email, Otro",
        },
      ],
    },
    bookclub: {
      title: "Club de Lectura: [Nombre del Libro]",
      description:
        "Nos reunimos para discutir '[Libro]'. Analizaremos los personajes, la trama y los temas principales. ¬°Trae tu caf√©!",
      capacity: 15,
      rules: [
        "Haber le√≠do al menos la mitad del libro",
        "Respetar las opiniones de los dem√°s",
      ],
      requirements: ["Tener una copia del libro"],
      customFields: [
        {
          label: "¬øYa has le√≠do el libro completo?",
          type: "checkbox",
          required: true,
        },
      ],
    },
  };

  // Helper to create simple text inputs (Rules/Requirements)
  function createSimpleInput(
    container: HTMLElement | null,
    placeholder: string,
    value = "",
  ) {
    if (!container) return;
    const wrapper = document.createElement("div");
    wrapper.className = "flex gap-2";
    wrapper.innerHTML = `
      <input type="text" value="${value}" class="flex-1 px-4 py-2 border border-[var(--m3-sys-outline)]/50 rounded-lg focus:ring-2 focus:ring-[var(--m3-sys-primary)] focus:border-[var(--m3-sys-primary)] outline-none bg-transparent text-[var(--m3-sys-on-surface)]" placeholder="${placeholder}" />
      <button type="button" class="text-[var(--m3-sys-error)] hover:opacity-80 px-2 remove-btn">‚úï</button>
    `;
    // Add event listener to new remove button
    wrapper
      .querySelector(".remove-btn")
      ?.addEventListener("click", () => wrapper.remove());
    container.appendChild(wrapper);
  }

  // Helper to create custom field inputs
  function createCustomFieldInput(
    container: HTMLElement | null,
    data: any = null,
  ) {
    if (!container) return;
    const id = Date.now() + Math.random().toString(36).substr(2, 5); // Unique ID
    const wrapper = document.createElement("div");
    wrapper.className =
      "p-4 bg-[var(--m3-sys-surface-variant)]/30 rounded-lg border border-[var(--m3-sys-outline)]/20 space-y-3 relative";

    const labelVal = data ? data.label : "";
    const typeVal = data ? data.type : "text"; // text, number, select, checkbox
    const requiredVal = data ? data.required : true;
    const optionsVal =
      data && data.options
        ? Array.isArray(data.options)
          ? data.options.join(", ")
          : data.options
        : "";
    const showOptions = typeVal === "select" ? "block" : "none";

    // Helper to generate select options
    const optionsHtml = `
      <option value="text" ${typeVal === "text" ? "selected" : ""}>Texto Corto</option>
      <option value="number" ${typeVal === "number" ? "selected" : ""}>N√∫mero</option>
      <option value="select" ${typeVal === "select" ? "selected" : ""}>Selecci√≥n M√∫ltiple</option>
      <option value="checkbox" ${typeVal === "checkbox" ? "selected" : ""}>Casilla (S√≠/No)</option>
    `;

    wrapper.innerHTML = `
      <button type="button" class="absolute top-2 right-2 text-[var(--m3-sys-on-surface-variant)] hover:text-[var(--m3-sys-error)] remove-field-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-medium text-[var(--m3-sys-on-surface-variant)] mb-1">Etiqueta de la Pregunta</label>
          <input type="text" name="field_label_${id}" value="${labelVal}" required placeholder="Ej. ¬øTienes alguna alergia?" class="w-full px-3 py-2 border border-[var(--m3-sys-outline)]/50 rounded bg-[var(--m3-sys-surface)] text-[var(--m3-sys-on-surface)]" />
        </div>
        <div>
          <label class="block text-xs font-medium text-[var(--m3-sys-on-surface-variant)] mb-1">Tipo de Respuesta</label>
          <select name="field_type_${id}" class="w-full px-3 py-2 border border-[var(--m3-sys-outline)]/50 rounded bg-[var(--m3-sys-surface)] text-[var(--m3-sys-on-surface)]" id="type_select_${id}">
            ${optionsHtml}
          </select>
        </div>
      </div>
      <div id="options_${id}" style="display: ${showOptions};">
        <label class="block text-xs font-medium text-[var(--m3-sys-on-surface-variant)] mb-1">Opciones (separadas por coma)</label>
        <input type="text" name="field_options_${id}" value="${optionsVal}" placeholder="Opci√≥n A, Opci√≥n B, Opci√≥n C" class="w-full px-3 py-2 border border-[var(--m3-sys-outline)]/50 rounded bg-[var(--m3-sys-surface)] text-[var(--m3-sys-on-surface)]" />
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" name="field_required_${id}" id="req_${id}" class="rounded text-[var(--m3-sys-primary)] focus:ring-[var(--m3-sys-primary)]" ${requiredVal ? "checked" : ""} />
        <label for="req_${id}" class="text-sm text-[var(--m3-sys-on-surface-variant)]">Respuesta obligatoria</label>
      </div>
    `;

    // Add event listeners
    wrapper
      .querySelector(".remove-field-btn")
      ?.addEventListener("click", () => wrapper.remove());

    const typeSelect = wrapper.querySelector(
      `#type_select_${id}`,
    ) as HTMLSelectElement;
    typeSelect.addEventListener("change", function () {
      const optsDiv = document.getElementById(`options_${id}`);
      if (optsDiv)
        optsDiv.style.display = this.value === "select" ? "block" : "none";
    });

    container.appendChild(wrapper);
  }

  function applyTemplate(templateKey: string) {
    //@ts-ignore
    const template = EVENT_TEMPLATES[templateKey];
    if (!template) return;

    // 1. Basic Fields
    (document.getElementById("title") as HTMLInputElement).value =
      template.title;
    (document.getElementById("description") as HTMLTextAreaElement).value =
      template.description;
    (document.getElementById("capacity") as HTMLInputElement).value =
      template.capacity;

    // 2. Rules
    if (rulesContainer) rulesContainer.innerHTML = "";
    template.rules.forEach((rule: string) =>
      createSimpleInput(rulesContainer, "Escribe una regla...", rule),
    );

    // 3. Requirements
    if (requirementsContainer) requirementsContainer.innerHTML = "";
    template.requirements.forEach((req: string) =>
      createSimpleInput(requirementsContainer, "Escribe un requisito...", req),
    );

    // 4. Custom Fields
    if (customFieldsContainer) customFieldsContainer.innerHTML = "";
    template.customFields.forEach((field: any) =>
      createCustomFieldInput(customFieldsContainer, field),
    );
  }

  // Load initial custom fields if editing
  const initialFieldsData = document.getElementById("initial-custom-fields");
  if (initialFieldsData && initialFieldsData.dataset.fields) {
    try {
      const fields = JSON.parse(initialFieldsData.dataset.fields);
      if (Array.isArray(fields)) {
        fields.forEach((field) =>
          createCustomFieldInput(customFieldsContainer, field),
        );
      }
    } catch (e) {
      console.error("Error parsing initial fields", e);
    }
  }

  // --- EVENT LISTENERS ---

  // Template Buttons
  document.querySelectorAll(".template-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const template = btn.getAttribute("data-template");
      if (template) applyTemplate(template);
    });
  });

  document
    .getElementById("add-rule-btn")
    ?.addEventListener("click", () =>
      createSimpleInput(rulesContainer, "Escribe una regla..."),
    );
  document
    .getElementById("add-req-btn")
    ?.addEventListener("click", () =>
      createSimpleInput(requirementsContainer, "Escribe un requisito..."),
    );
  document
    .getElementById("add-field-btn")
    ?.addEventListener("click", () =>
      createCustomFieldInput(customFieldsContainer),
    );

  // Form Submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!auth.currentUser) {
      alert("Debes iniciar sesi√≥n");
      return;
    }

    // Disable submit button to prevent double submit
    const submitBtn = form.querySelector(
      'button[type="submit"]',
    ) as HTMLButtonElement;
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = "Procesando...";

    try {
      const formData = new FormData(form);
      const isEditing = form.dataset.isEditing === "true";
      const eventId = form.dataset.eventId;

      // Collect Dynamic Data
      const rules = Array.from(rulesContainer?.querySelectorAll("input") || [])
        .map((input) => input.value)
        .filter(Boolean);
      const requirements = Array.from(
        requirementsContainer?.querySelectorAll("input") || [],
      )
        .map((input) => input.value)
        .filter(Boolean);

      // Parse Custom Fields
      const customFields: CustomField[] = [];
      const fieldWrappers = customFieldsContainer?.children || [];

      for (const wrapper of Array.from(fieldWrappers)) {
        const labelInput = wrapper.querySelector(
          'input[name^="field_label"]',
        ) as HTMLInputElement;
        const typeSelect = wrapper.querySelector(
          'select[name^="field_type"]',
        ) as HTMLSelectElement;
        const requiredCheck = wrapper.querySelector(
          'input[name^="field_required"]',
        ) as HTMLInputElement;
        const optionsInput = wrapper.querySelector(
          'input[name^="field_options"]',
        ) as HTMLInputElement;

        if (labelInput && labelInput.value) {
          customFields.push({
            label: labelInput.value,
            type: typeSelect.value as any,
            required: requiredCheck.checked,
            options:
              typeSelect.value === "select"
                ? optionsInput.value
                    .split(",")
                    .map((s) => s.trim())
                    .filter(Boolean)
                : undefined,
          });
        }
      }

      const eventData = {
        title: formData.get("title") as string,
        description: formData.get("description") as string,
        location: formData.get("location") as string,
        startDate: new Date(formData.get("startDate") as string),
        endDate: new Date(formData.get("endDate") as string),
        capacity: Number(formData.get("capacity")),
        bannerUrl: formData.get("bannerUrl") as string,
        rules,
        requirements,
        customFields,
        // Only update status if creating, or keep as is?
        // For simple edit, we might want to keep status.
        // If creating, default to published for now.
        ...(isEditing
          ? {}
          : { status: "published" as const, createdBy: auth.currentUser.uid }),
      };

      if (isEditing && eventId) {
        await updateEvent(eventId, eventData);
        alert("¬°Evento actualizado con √©xito!");
        window.location.href = `/events/${eventId}`;
      } else {
        await createEvent(eventData as any);
        alert("¬°Evento creado con √©xito!");
        window.location.href = "/events"; // Redirect to list
      }
    } catch (error) {
      console.error(error);
      alert("Error: " + (error as Error).message);
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
    }
  });
</script>
