---
import SideSheet from "../../components/ui/SideSheet.astro";
import TextField from "../../components/ui/TextField.astro";
import Button from "../../components/ui/Button.astro";
---

<SideSheet id="return-sidesheet" title="Registrar Devolución">
  <form class="flex flex-col gap-8" onsubmit="window.processReturn(event)">
    <div class="flex flex-col gap-5">
      <div
        class="p-4 bg-[var(--m3-sys-tertiary-container)]/30 rounded-lg border border-[var(--m3-sys-tertiary-container)] text-[var(--m3-sys-on-surface)]"
      >
        <p class="text-sm">
          Ingrese el ID del préstamo o escanee el código del libro para procesar
          la devolución.
        </p>
      </div>

      <div class="relative group">
        <label
          for="return-search"
          class="text-xs font-medium text-[var(--m3-sys-on-surface-variant)] px-1 mb-1.5 block"
        >
          ID del Préstamo / Código del Libro <span
            class="text-[var(--m3-sys-error)] ml-0.5">*</span
          >
        </label>
        <div class="relative">
          <input
            type="text"
            id="return-search"
            placeholder="Buscar por ID, Título o Alumno..."
            class="peer w-full px-4 py-3 rounded-[var(--m3-radius-sm)] bg-transparent border-b-2 border-[var(--m3-sys-outline-variant)] text-[var(--m3-sys-on-surface)] text-base focus:outline-none focus:border-[var(--m3-sys-primary)] transition-colors placeholder:text-[var(--m3-sys-on-surface-variant)]/50"
            autocomplete="off"
            autofocus
          />
          <div
            class="absolute right-3 top-1/2 -translate-y-1/2 text-[var(--m3-sys-on-surface-variant)] pointer-events-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
              ></path></svg
            >
          </div>
        </div>

        <!-- Search Results Dropdown -->
        <div
          id="return-dropdown"
          class="absolute z-10 left-0 right-0 top-full mt-1 bg-[var(--m3-sys-surface)] rounded-[var(--m3-radius-md)] shadow-lg border border-[var(--m3-sys-outline-variant)] max-h-60 overflow-y-auto hidden"
        >
          <ul id="return-options-list" class="flex flex-col py-2">
            <!-- Options will be injected here -->
          </ul>
        </div>
      </div>

      <div class="flex flex-col gap-2">
        <label
          class="text-sm font-medium text-[var(--m3-sys-on-surface-variant)] ml-1"
          >Estado del Libro</label
        >
        <select
          id="return-status"
          class="w-full px-4 py-3 rounded-[var(--m3-radius-lg)] border border-[var(--m3-sys-outline)] bg-[var(--m3-sys-surface)] text-[var(--m3-sys-on-surface)] outline-none focus:border-[var(--m3-sys-primary)] transition-all"
        >
          <option value="good" selected>Buen Estado</option>
          <option value="damaged">Dañado</option>
          <option value="lost">Perdido</option>
        </select>
      </div>

      <TextField
        label="Observaciones (Opcional)"
        placeholder="Daños menores en portada..."
        id="return-notes"
      />
    </div>

    <div class="flex flex-col gap-3 mt-4">
      <Button type="submit" class="w-full !py-4 shadow-lg text-base"
        >Confirmar Devolución</Button
      >
      <Button
        variant="text"
        type="button"
        onclick="window.closeReturnSidesheet()"
        class="w-full">Cancelar</Button
      >
    </div>
  </form>
</SideSheet>

<script>
  import {
    subscribeToLoans,
    updateLoan,
    type Loan,
  } from "../../services/firebase/loans";
  import {
    subscribeToBooks,
    updateBook,
    type Book,
  } from "../../services/firebase/books";

  let activeLoans: Loan[] = [];
  let allBooks: Book[] = [];
  let currentSelectedLoan: Loan | null = null;

  const returnSearch = document.getElementById(
    "return-search",
  ) as HTMLInputElement;
  const returnDropdown = document.getElementById("return-dropdown");
  const returnOptionsList = document.getElementById("return-options-list");

  // Subscribe to real data
  subscribeToLoans((loans) => {
    activeLoans = loans.filter((loan) => loan.status === "active");
  });

  subscribeToBooks((books) => {
    allBooks = books;
  });

  function filterLoans(query: string) {
    if (!query) return [];
    const lowerQuery = query.toLowerCase();
    return activeLoans.filter(
      (loan) =>
        loan.id?.toLowerCase().includes(lowerQuery) ||
        loan.bookTitle.toLowerCase().includes(lowerQuery) ||
        loan.studentName.toLowerCase().includes(lowerQuery) ||
        loan.studentId.toLowerCase().includes(lowerQuery),
    );
  }

  function renderReturnOptions(options: Loan[]) {
    if (!returnOptionsList) return;
    returnOptionsList.innerHTML = "";

    if (options.length === 0) {
      const noResult = document.createElement("li");
      noResult.className =
        "px-4 py-3 text-sm text-[var(--m3-sys-on-surface-variant)] italic";
      noResult.textContent = "No se encontraron préstamos activos";
      returnOptionsList.appendChild(noResult);
      return;
    }

    options.forEach((loan) => {
      const li = document.createElement("li");
      li.className =
        "px-4 py-3 hover:bg-[var(--m3-sys-surface-variant)]/50 cursor-pointer transition-colors text-[var(--m3-sys-on-surface)] flex flex-col gap-0.5 border-b border-[var(--m3-sys-outline-variant)]/50 last:border-0";
      li.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium text-sm">${loan.bookTitle}</span>
                    <span class="text-xs bg-[var(--m3-sys-primary-container)] text-[var(--m3-sys-on-primary-container)] px-2 py-0.5 rounded-full">${loan.id?.slice(-6).toUpperCase() || "ID"}</span>
                </div>
                <div class="flex justify-between text-xs text-[var(--m3-sys-on-surface-variant)]">
                    <span>${loan.studentName}</span>
                    <span>Vence: ${loan.dueDate}</span>
                </div>
            `;
      li.onclick = () => selectLoan(loan);
      returnOptionsList.appendChild(li);
    });
  }

  function selectLoan(loan: Loan) {
    if (!returnSearch) return;
    returnSearch.value = `${loan.bookTitle} (${loan.studentName})`;
    currentSelectedLoan = loan;
    if (returnDropdown) returnDropdown.classList.add("hidden");
  }

  returnSearch?.addEventListener("input", (e) => {
    const query = (e.target as HTMLInputElement).value;
    currentSelectedLoan = null;

    if (!query) {
      if (returnDropdown) returnDropdown.classList.add("hidden");
      return;
    }

    const filtered = filterLoans(query);
    renderReturnOptions(filtered);
    if (returnDropdown) returnDropdown.classList.remove("hidden");
  });

  returnSearch?.addEventListener("focus", () => {
    if (returnSearch.value && returnDropdown) {
      returnDropdown.classList.remove("hidden");
    }
  });

  document.addEventListener("click", (e) => {
    if (
      !returnSearch?.contains(e.target as Node) &&
      !returnDropdown?.contains(e.target as Node)
    ) {
      returnDropdown?.classList.add("hidden");
    }
  });

  // @ts-ignore
  window.processReturn = async (e: Event) => {
    e.preventDefault();

    if (!currentSelectedLoan) {
      alert("Por favor selecciona un préstamo de la lista.");
      return;
    }

    const status = (
      document.getElementById("return-status") as HTMLSelectElement
    ).value;
    const notes = (document.getElementById("return-notes") as HTMLInputElement)
      .value;

    try {
      // 1. Update Loan status
      await updateLoan(currentSelectedLoan.id!, {
        status: status === "lost" ? "lost" : "returned",
        returnDate: new Date().toISOString().split("T")[0],
        notes: notes,
      });

      // 2. Increment book availability if returned (even if damaged, it's back in inventory)
      // Only if not lost
      if (status !== "lost") {
        const book = allBooks.find((b) => b.id === currentSelectedLoan!.bookId);
        if (book) {
          await updateBook(book.id!, {
            available: (book.available || 0) + 1,
          });
        }
      }

      alert(
        `Devolución registrada exitosamente para ${currentSelectedLoan.bookTitle}.`,
      );

      // Reset and close
      if (returnSearch) returnSearch.value = "";
      const notesEl = document.getElementById(
        "return-notes",
      ) as HTMLInputElement;
      if (notesEl) notesEl.value = "";
      currentSelectedLoan = null;

      // @ts-ignore
      window.closeReturnSidesheet();
    } catch (error) {
      console.error("Error processing return:", error);
      alert("Hubo un error al procesar la devolución.");
    }
  };
</script>
