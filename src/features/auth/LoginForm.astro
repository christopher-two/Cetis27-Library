---
import Button from "../../components/ui/Button.astro";
---

<div class="flex flex-col gap-8">
  <div class="text-left space-y-2">
    <h2
      class="font-display text-4xl font-bold text-[var(--m3-sys-on-surface)] tracking-tight"
    >
      Bienvenido
    </h2>
    <p class="text-base text-[var(--m3-sys-on-surface-variant)]">
      Ingresa tus credenciales para continuar
    </p>
  </div>

  <form class="flex flex-col gap-6" id="login-form">
    <div class="space-y-5">
      <div class="group">
        <label
          for="email"
          class="block text-xs font-semibold uppercase tracking-wider text-[var(--m3-sys-on-surface-variant)] mb-2 ml-1"
          >Correo Electrónico</label
        >
        <input
          type="email"
          id="email"
          placeholder="bibliotecario@ejemplo.com"
          required
          class="w-full px-4 py-3.5 bg-[var(--m3-sys-surface-variant)]/30 border-2 border-transparent rounded-xl text-[var(--m3-sys-on-surface)] placeholder:text-[var(--m3-sys-on-surface-variant)]/50 focus:bg-[var(--m3-sys-surface)] focus:border-[var(--m3-sys-primary)] focus:outline-none transition-all duration-300 font-medium"
        />
      </div>
      <div class="group">
        <label
          for="password"
          class="block text-xs font-semibold uppercase tracking-wider text-[var(--m3-sys-on-surface-variant)] mb-2 ml-1"
          >Contraseña</label
        >
        <input
          type="password"
          id="password"
          placeholder="••••••••"
          required
          class="w-full px-4 py-3.5 bg-[var(--m3-sys-surface-variant)]/30 border-2 border-transparent rounded-xl text-[var(--m3-sys-on-surface)] placeholder:text-[var(--m3-sys-on-surface-variant)]/50 focus:bg-[var(--m3-sys-surface)] focus:border-[var(--m3-sys-primary)] focus:outline-none transition-all duration-300 font-medium"
        />
      </div>
    </div>

    <div class="pt-2">
      <Button
        size="lg"
        type="submit"
        class="w-full !rounded-xl !py-4 !text-base !font-display !font-bold shadow-lg shadow-[var(--m3-sys-primary)]/20 hover:shadow-[var(--m3-sys-primary)]/40 hover:-translate-y-0.5 transition-all"
      >
        Iniciar Sesión
      </Button>
    </div>

    <p
      id="error-message"
      class="text-center text-[var(--m3-sys-error)] text-sm font-medium bg-[var(--m3-sys-error-container)] p-3 rounded-lg hidden animate-shake"
    >
    </p>
  </form>
</div>

<script>
  import { auth } from "../../lib/firebase";
  import { signInWithEmailAndPassword } from "firebase/auth";

  const loginForm = document.getElementById("login-form");
  const errorMessage = document.getElementById("error-message");

  loginForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = (document.getElementById("email") as HTMLInputElement).value;
    const password = (document.getElementById("password") as HTMLInputElement)
      .value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // Auth state listener in Layout.astro will handle redirection
      localStorage.setItem("isAuthenticated", "true"); // Fallback/Speed
      window.location.href = "/dashboard";
    } catch (error: any) {
      if (errorMessage) {
        errorMessage.textContent =
          "Credenciales incorrectas. Inténtalo de nuevo.";
        errorMessage.classList.remove("hidden");
      }
      console.error("Login failed:", error);
    }
  });
</script>
